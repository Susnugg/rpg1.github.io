<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE DRY WORLD - RPG</title>
    <style>
        :root { --main: #ff9933; --bg: #0d0d0d; --panel: #1a1a1a; --accent: #00ccff; --people: #a29bfe; }
        body { background: var(--bg); color: #ddd; font-family: 'Courier New', Courier, monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; transition: background 2s; overflow: hidden; }
        
        body.day { background: #1a0f00; }
        body.night { background: #050510; }

        #game-container { display: flex; width: 98%; max-width: 1200px; height: 94vh; border: 1px solid #333; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        #main-window { flex: 2.5; display: flex; flex-direction: column; background: rgba(20, 20, 20, 0.95); border-right: 1px solid #333; }
        
        /* HUD */
        #hud { display: none; background: #000; padding: 15px; border-bottom: 2px solid var(--main); flex-direction: column; gap: 8px; }
        .hud-top { display: flex; justify-content: space-around; font-weight: bold; font-size: 14px; color: var(--main); }
        #env-bar { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #888; text-align: center; border-bottom: 1px solid #222; padding-bottom: 5px; }

        /* Sidebar Tabs */
        #sidebar { flex: 1; background: #000; display: none; flex-direction: column; border-left: 1px solid #333; }
        .tabs { display: flex; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; padding: 12px; background: #111; border: none; color: #555; cursor: pointer; font-family: inherit; font-size: 11px; font-weight: bold; }
        .tab-btn.active { background: #000; color: var(--main); border-bottom: 2px solid var(--main); }
        .tab-content { padding: 15px; flex-grow: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }

        /* NPC Cards - Updated Look */
        .npc-card { background: #111; padding: 12px; margin-bottom: 12px; border: 1px solid #333; border-radius: 4px; border-left: 4px solid var(--people); }
        .npc-name { color: var(--people); font-weight: bold; font-size: 15px; display: block; margin-bottom: 4px; text-transform: uppercase; }
        .npc-stat { font-size: 11px; color: #999; margin: 3px 0; }
        .npc-stat b { color: #555; }
        .rel-bar-bg { width: 100%; height: 5px; background: #222; margin-top: 6px; border-radius: 10px; overflow: hidden; }
        .rel-bar-fill { height: 100%; background: var(--people); transition: width 0.8s ease-in-out; }

        /* Story Area */
        #output { flex-grow: 1; overflow-y: auto; padding: 25px; line-height: 1.8; font-size: 16px; scroll-behavior: smooth; }
        .action-text { margin-bottom: 15px; color: #ccc; display: block; white-space: pre-wrap; }
        .dialogue-box { color: #fff; border-left: 4px solid var(--main); padding: 15px; margin: 25px 0; background: rgba(255,153,51,0.08); font-size: 17px; }
        .user-txt { color: var(--accent); margin: 20px 0; font-weight: bold; text-align: right; font-style: italic; }
        .ai-txt-block { margin-bottom: 50px; border-bottom: 1px solid #222; padding-bottom: 30px; }

        #input-area { padding: 15px; background: #000; display: none; border-top: 1px solid #333; }
        input[type="text"] { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 12px; outline: none; box-sizing: border-box; font-family: inherit; }
        
        #creator { padding: 50px; text-align: center; width: 100%; }
        .input-box { width: 80%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 10px; font-family: inherit; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="main-window">
        <div id="hud">
            <div id="env-bar">REGION: INITIALIZING... | TIME: --:--</div>
            <div class="hud-top">
                <span>WALLET: <span id="cash-val" style="color: #fff;">$50</span></span>
            </div>
        </div>
        <div id="creator">
            <h1 style="color:var(--main); letter-spacing: 5px;">THE DRY WORLD</h1>
            <input type="text" id="c-job" class="input-box" placeholder="Profession">
            <input type="text" id="c-pers" class="input-box" placeholder="Personality">
            <input type="password" id="api-key" class="input-box" placeholder="Groq API Key">
            <button onclick="startGame()" style="background:var(--main); padding:15px; border:none; width:80%; cursor:pointer; font-weight:bold;">AWAKEN</button>
        </div>
        <div id="output"></div>
        <div id="input-area"><input type="text" id="user-input" placeholder="Type your action..." onkeypress="if(event.key==='Enter') sendAction()"></div>
    </div>
    <div id="sidebar">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('inv-tab', this)">EQUIPMENT</button>
            <button class="tab-btn" onclick="showTab('npc-tab', this)">PEOPLE</button>
        </div>
        <div id="inv-tab" class="tab-content active"><ul id="inventory-list" style="list-style:none; padding:0;"></ul></div>
        <div id="npc-tab" class="tab-content"><div id="npc-list"></div></div>
    </div>
</div>

<script>
    let messages = [], stats = { cash: 50 }, inventory = [], people = {};
    let currentTime = 480; 

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function updateUI(location = "WASTELAND") {
        document.getElementById('cash-val').innerText = "$" + stats.cash;
        let h = Math.floor(currentTime / 60) % 24, m = Math.floor(currentTime % 60);
        document.getElementById('env-bar').innerText = `REGION: ${location} | TIME: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        document.body.className = (h >= 6 && h <= 18) ? 'day' : 'night';

        // Gear
        document.getElementById('inventory-list').innerHTML = inventory.map(i => `<li style="padding:10px; border-bottom:1px solid #111; font-size:13px;">â—ˆ ${i}</li>`).join('') || "<li style='color:#444'>Pockets are empty.</li>";
        
        // People
        const nList = document.getElementById('npc-list');
        nList.innerHTML = "";
        const personKeys = Object.keys(people);
        if (personKeys.length === 0) {
            nList.innerHTML = "<div style='color:#444; font-size:12px;'>No contacts yet.</div>";
        } else {
            personKeys.forEach(name => {
                let p = people[name];
                nList.innerHTML += `
                    <div class="npc-card">
                        <span class="npc-name">${name}</span>
                        <div class="npc-stat"><b>ROLE:</b> ${p.job}</div>
                        <div class="npc-stat"><b>CASH:</b> $${p.cash}</div>
                        <div class="rel-bar-bg"><div class="rel-bar-fill" style="width:${p.rel}%"></div></div>
                    </div>`;
            });
        }
    }

    async function startGame() {
        const key = document.getElementById('api-key').value;
        if (!key) return alert("Key needed.");
        localStorage.setItem('groq_key', key);
        
        messages = [{ 
            role: "system", 
            content: `Narrator for 'The Dry World'.
            PLAYER: Job: ${document.getElementById('c-job').value}, Personality: ${document.getElementById('c-pers').value}.
            
            RULES:
            1. DIALOGUE: (NAME: "Speech") - MUST be used for all talking.
            2. NPC TAGS: You MUST use [NPC:Name|Role|Affinity|Cash] every time a character speaks or is introduced.
            3. RELATIONS: Affinity is 0-100.
            4. TAGS: [CASH+5], [GET:Item], [LOSE:Item], [LOC:Region Name].
            5. Provide Options A, B, C, D.` 
        }];

        document.getElementById('creator').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('sidebar').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        sendAction("The desert sun hits my face.");
    }

    async function sendAction(text) {
        const input = document.getElementById('user-input');
        const val = text || input.value;
        if (!val) return;
        if (!text) appendMessage(val, "user-txt");
        input.value = "";
        currentTime += 30;
        messages.push({ role: "user", content: val });

        try {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${localStorage.getItem('groq_key')}` },
                body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: messages, temperature: 0.8 })
            });
            const data = await res.json();
            const aiMsg = data.choices[0].message.content;

            // 1. Process Stats
            const cashMatch = aiMsg.match(/\[CASH\s*([\+\-]\d+)\]/i);
            if(cashMatch) stats.cash = Math.max(0, stats.cash + parseInt(cashMatch[1]));
            
            // 2. Process Gear
            const gearM = aiMsg.matchAll(/\[(GET|LOSE):\s*(.*?)\]/gi);
            for (const m of gearM) {
                const item = m[2].trim();
                if(m[1].toUpperCase() === "GET") inventory.push(item);
                else inventory = inventory.filter(i => i.toLowerCase() !== item.toLowerCase());
            }

            // 3. Process People (Robust Regex)
            const npcM = aiMsg.matchAll(/\[NPC:\s*([^|\]]+)\|([^|\]]+)\|([^|\]]+)\|([^|\]]+)\]/g);
            for (const m of npcM) {
                const name = m[1].trim();
                people[name] = { 
                    job: m[2].trim(), 
                    rel: m[3].replace(/\D/g,'') || 50, 
                    cash: m[4].replace(/\D/g,'') || 0 
                };
            }
            
            const leaveM = aiMsg.matchAll(/\[NPC_LEAVE:\s*(.*?)\]/g);
            for (const m of leaveM) delete people[m[1].trim()];

            const locMatch = aiMsg.match(/\[LOC:\s*(.*?)\]/i);
            updateUI(locMatch ? locMatch[1].trim() : undefined);
            
            formatAndAppendAI(aiMsg.replace(/\[.*?\]/g, "").trim());
            messages.push({ role: "assistant", content: aiMsg });
        } catch (e) { console.error("Wasteland Error:", e); }
    }

    function formatAndAppendAI(text) {
        const out = document.getElementById('output');
        const block = document.createElement('div');
        block.className = "ai-txt-block";

        const dialogueRegex = /\(([^)]+):\s*"([^"]+)"\)/g;
        let lastIndex = 0, match;

        while ((match = dialogueRegex.exec(text)) !== null) {
            const preText = text.substring(lastIndex, match.index).trim();
            if (preText) {
                const span = document.createElement('span');
                span.className = "action-text";
                span.innerText = preText;
                block.appendChild(span);
            }
            
            const dBox = document.createElement('div');
            dBox.className = "dialogue-box";
            // Bolded dialogue
            dBox.innerHTML = `(${match[1]}: <strong>"${match[2]}"</strong>)`;
            block.appendChild(dBox);
            
            lastIndex = dialogueRegex.lastIndex;
        }

        const postText = text.substring(lastIndex).trim();
        if (postText) {
            const span = document.createElement('span');
            span.className = "action-text";
            span.innerText = postText;
            block.appendChild(span);
        }

        out.appendChild(block);
        out.scrollTop = out.scrollHeight;
    }

    function appendMessage(text, cls) {
        const out = document.getElementById('output'), div = document.createElement('div');
        div.className = cls;
        div.innerText = "> " + text;
        out.appendChild(div);
        out.scrollTop = out.scrollHeight;
    }
</script>

</body>
</html>
