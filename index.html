<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE DRY WORLD - RPG</title>
    <style>
        :root { --main: #ff9933; --bg: #0d0d0d; --panel: #1a1a1a; --danger: #ff4444; --accent: #00ccff; --people: #a29bfe; }
        body { background: var(--bg); color: #ddd; font-family: 'Courier New', Courier, monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; transition: background 2s; overflow: hidden; }
        
        body.day { background: #1a0f00; }
        body.night { background: #050510; }

        #game-container { display: flex; width: 98%; max-width: 1200px; height: 94vh; border: 1px solid #333; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        #main-window { flex: 2.5; display: flex; flex-direction: column; background: rgba(20, 20, 20, 0.95); border-right: 1px solid #333; }
        
        /* HUD */
        #hud { display: none; background: #000; padding: 15px; border-bottom: 2px solid var(--main); flex-direction: column; gap: 8px; }
        .hud-top { display: flex; justify-content: space-around; font-weight: bold; font-size: 13px; }
        .bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin: 4px 0; }
        #hp-bar { height: 100%; width: 100%; background: #2ecc71; transition: width 0.5s; }
        #env-bar { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #666; text-align: center; }

        /* Sidebar */
        #sidebar { flex: 1; background: #000; display: none; flex-direction: column; border-left: 1px solid #333; }
        .tabs { display: flex; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; padding: 12px; background: #111; border: none; color: #555; cursor: pointer; font-family: inherit; font-size: 11px; font-weight: bold; }
        .tab-btn.active { background: #000; color: var(--main); border-bottom: 2px solid var(--main); }
        .tab-content { padding: 15px; flex-grow: 1; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }

        /* NPC Cards */
        .npc-card { background: #0a0a0a; padding: 12px; margin-bottom: 12px; border: 1px solid #222; border-radius: 4px; }
        .npc-name { color: var(--people); font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px; }
        .npc-stat { font-size: 11px; color: #777; margin: 2px 0; }
        .rel-bar-bg { width: 100%; height: 4px; background: #222; margin-top: 5px; border-radius: 2px; }
        .rel-bar-fill { height: 100%; background: var(--people); transition: width 0.5s; }

        /* Output & Dialogue Formatting */
        #output { flex-grow: 1; overflow-y: auto; padding: 25px; line-height: 1.8; font-size: 16px; scroll-behavior: smooth; }
        .action-text { margin-bottom: 15px; color: #bbb; display: block; }
        .dialogue-box { color: #fff; font-weight: 900; border-left: 4px solid var(--main); padding: 12px 15px; margin: 20px 0; background: rgba(255,153,51,0.08); font-size: 17px; }
        .user-txt { color: var(--accent); margin: 20px 0; font-weight: bold; text-align: right; font-style: italic; }
        .ai-txt-block { margin-bottom: 40px; }

        #input-area { padding: 15px; background: #000; display: none; border-top: 1px solid #333; }
        input[type="text"] { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 12px; outline: none; box-sizing: border-box; font-family: inherit; }
        
        #creator { padding: 50px; text-align: center; width: 100%; }
        .input-box { width: 80%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 10px; font-family: inherit; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="main-window">
        <div id="hud">
            <div id="env-bar">REGION: SCANNING...</div>
            <div class="bar-bg"><div id="hp-bar"></div></div>
            <div class="hud-top">
                <span>CASH: <span id="cash-val">$50</span></span>
                <span>FOOD: <span id="food-val">3</span></span>
            </div>
        </div>
        <div id="creator">
            <h1 style="color:var(--main); letter-spacing: 5px;">THE DRY WORLD</h1>
            <input type="text" id="c-job" class="input-box" placeholder="Your Profession">
            <input type="text" id="c-pers" class="input-box" placeholder="Your Personality">
            <input type="password" id="api-key" class="input-box" placeholder="Groq API Key">
            <button onclick="startGame()" style="background:var(--main); padding:15px; border:none; width:80%; cursor:pointer; font-weight:bold;">AWAKEN</button>
        </div>
        <div id="output"></div>
        <div id="input-area"><input type="text" id="user-input" placeholder="A, B, C or custom action..." onkeypress="if(event.key==='Enter') sendAction()"></div>
    </div>
    <div id="sidebar">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('inv-tab', this)">EQUIPMENT</button>
            <button class="tab-btn" onclick="showTab('npc-tab', this)">CONTACTS</button>
        </div>
        <div id="inv-tab" class="tab-content active"><ul id="inventory-list" style="list-style:none; padding:0;"></ul></div>
        <div id="npc-tab" class="tab-content"><div id="npc-list"></div></div>
    </div>
</div>

<script>
    let messages = [], stats = { hp: 100, cash: 50, food: 3 }, inventory = [], people = {};
    let currentTime = 480; 

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function updateUI(location = "WASTELAND") {
        document.getElementById('hp-bar').style.width = stats.hp + "%";
        document.getElementById('cash-val').innerText = "$" + stats.cash;
        document.getElementById('food-val').innerText = stats.food;

        let h = Math.floor(currentTime / 60) % 24;
        let m = Math.floor(currentTime % 60);
        document.getElementById('env-bar').innerText = `REGION: ${location} | TIME: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        document.body.className = (h >= 6 && h <= 18) ? 'day' : 'night';

        document.getElementById('inventory-list').innerHTML = inventory.map(i => `<li style="padding:8px; border-bottom:1px solid #111">â–£ ${i}</li>`).join('') || "No items.";
        
        const nList = document.getElementById('npc-list');
        nList.innerHTML = "";
        for (let name in people) {
            let p = people[name];
            nList.innerHTML += `
                <div class="npc-card">
                    <span class="npc-name">ðŸ‘¤ ${name}</span>
                    <div class="npc-stat">Role: ${p.job}</div>
                    <div class="npc-stat">Affinity:</div>
                    <div class="rel-bar-bg"><div class="rel-bar-fill" style="width:${p.rel}%"></div></div>
                </div>`;
        }
    }

    async function startGame() {
        const key = document.getElementById('api-key').value;
        if (!key) return alert("API Key Required.");
        localStorage.setItem('groq_key', key);
        
        messages = [{ 
            role: "system", 
            content: `Narrator for 'The Dry World'.
            PLAYER: Job: ${document.getElementById('c-job').value}, Personality: ${document.getElementById('c-pers').value}.
            
            RULES:
            1. DIALOGUE: Use format (NAME: "Dialogue"). 
            2. SPACING: Keep background narration and dialogue separate.
            3. NPC LOGS: Only use [NPC:Name|Role|Rel|Cash] tags if the character has a known name. Do NOT add NPCs to the log if they are just "a stranger" or "a figure".
            4. End with Options A, B, C, D.
            5. TAGS: [HP-10], [CASH+5], [GET:Item], [LOSE:Item], [LOC:Region Name].` 
        }];

        document.getElementById('creator').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('sidebar').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        sendAction("Awaken me.");
    }

    async function sendAction(text) {
        const input = document.getElementById('user-input');
        const val = text || input.value;
        if (!val) return;
        if (!text) appendMessage(val, "user-txt");
        input.value = "";
        currentTime += 30;
        messages.push({ role: "user", content: val });

        try {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${localStorage.getItem('groq_key')}` },
                body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: messages, temperature: 0.85 })
            });
            const data = await res.json();
            const aiMsg = data.choices[0].message.content;

            // Stats Processing
            const statM = aiMsg.matchAll(/\[(HP|CASH|FOOD)([\+\-]\d+)\]/g);
            for (const m of statM) stats[m[1].toLowerCase()] = Math.min(m[1] === 'HP' ? 100 : 9999, Math.max(0, stats[m[1].toLowerCase()] + parseInt(m[2])));
            
            const invM = aiMsg.matchAll(/\[(GET|LOSE):(.*?)\]/g);
            for (const m of invM) m[1] === "GET" ? inventory.push(m[2]) : inventory = inventory.filter(i => i !== m[2]);

            // Only add NPC if name is not "Stranger" or "Unknown"
            const npcM = aiMsg.matchAll(/\[NPC:(.*?)\|(.*?)\|(.*?)\|(.*?)\]/g);
            for (const m of npcM) {
                let name = m[1].trim();
                if(!name.toLowerCase().includes("stranger") && !name.toLowerCase().includes("unknown")) {
                    people[name] = { job: m[2].trim(), rel: m[3].replace(/\D/g,''), cash: m[4].replace(/\D/g,'') };
                }
            }
            
            const leaveM = aiMsg.matchAll(/\[NPC_LEAVE:(.*?)\]/g);
            for (const m of leaveM) delete people[m[1].trim()];

            const locMatch = aiMsg.match(/\[LOC:(.*?)\]/);
            updateUI(locMatch ? locMatch[1] : undefined);
            
            formatAndAppendAI(aiMsg.replace(/\[.*?\]/g, "").trim());
            messages.push({ role: "assistant", content: aiMsg });
        } catch (e) { console.error(e); }
    }

    function formatAndAppendAI(text) {
        const out = document.getElementById('output');
        const block = document.createElement('div');
        block.className = "ai-txt-block";

        // Regex to split dialogue from background text
        const dialogueRegex = /\(([^)]+):\s*"([^"]+)"\)/g;
        let lastIndex = 0, match;

        while ((match = dialogueRegex.exec(text)) !== null) {
            // Narrative/Background text before the talking
            const preText = text.substring(lastIndex, match.index).trim();
            if (preText) {
                const actionSpan = document.createElement('span');
                actionSpan.className = "action-text";
                actionSpan.innerText = preText;
                block.appendChild(actionSpan);
            }
            
            // Bolded Dialogue Box
            const dBox = document.createElement('div');
            dBox.className = "dialogue-box";
            dBox.innerHTML = `(${match[1]}: "<strong>${match[2]}</strong>")`;
            block.appendChild(dBox);
            
            lastIndex = dialogueRegex.lastIndex;
        }

        // Catch remaining narrative text (like options A/B/C)
        const postText = text.substring(lastIndex).trim();
        if (postText) {
            const endSpan = document.createElement('span');
            endSpan.className = "action-text";
            endSpan.innerText = postText;
            block.appendChild(endSpan);
        }

        out.appendChild(block);
        out.scrollTop = out.scrollHeight;
    }

    function appendMessage(text, cls) {
        const out = document.getElementById('output'), div = document.createElement('div');
        div.className = cls;
        div.innerText = "> " + text;
        out.appendChild(div);
        out.scrollTop = out.scrollHeight;
    }
</script>

</body>
</html>
